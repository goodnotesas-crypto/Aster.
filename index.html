<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>æ±åŒ—å†°é›ªä¹‹æ—… 2026</title>
    
    <!-- ä½¿ç”¨ Firebase Compat ç‰ˆæœ¬ -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // --- 1. Firebase è¨­å®š ---
        const firebaseConfig = {
          apiKey: "AIzaSyCiYsU8NpuEV9Eo5QiKJU-GOt5BJjCCcwg",
          authDomain: "dongbei-travel.firebaseapp.com",
          // é è¨­è³‡æ–™åº«ç¶²å€
          databaseURL: "https://dongbei-travel-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "dongbei-travel",
          storageBucket: "dongbei-travel.firebasestorage.app",
          messagingSenderId: "154216136618",
          appId: "1:154216136618:web:c8e222b8bcc1d70475b5d3"
        };

        // åˆå§‹åŒ– Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.database();
            
            // ç¶å®šåˆ°å…¨åŸŸè®Šæ•¸
            window.db = db;
            window.ref = (db, path) => firebase.database().ref(path);
            window.set = (ref, val) => ref.set(val);
            window.onValue = (ref, callback, errorCallback) => ref.on('value', callback, errorCallback);

            console.log("Firebase åˆå§‹åŒ–æˆåŠŸ");
            
            setTimeout(() => {
                 window.dispatchEvent(new Event('firebase-ready'));
            }, 500);

        } catch (e) {
            alert("Firebase è¨­å®šéŒ¯èª¤ï¼š" + e.message);
            console.error(e);
        }
    </script>

    <style>
        /* CSS æ¨£å¼ */
        :root { --primary: #C19A6B; --secondary: #E6C288; --bg: #FFF8E7; --card-bg: #FFFFFF; --text: #5C4033; --text-light: #8B7355; --accent: #D2691E; --safe-area-bottom: env(safe-area-inset-bottom); }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background-color: var(--bg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { background: linear-gradient(to bottom, var(--primary), var(--secondary)); padding: 50px 20px 15px; color: white; text-align: center; font-weight: bold; font-size: 1.2rem; box-shadow: 0 2px 10px rgba(193, 154, 107, 0.3); flex-shrink: 0; }
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: calc(80px + var(--safe-area-bottom)); }
        nav { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); border-top: 1px solid #eee; display: flex; justify-content: space-around; padding: 10px 0 calc(10px + var(--safe-area-bottom)); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 0.75rem; color: var(--text-light); text-decoration: none; flex: 1; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-icon { font-size: 1.5rem; margin-bottom: 4px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(92, 64, 51, 0.08); position: relative; }
        h2, h3 { margin-top: 0; color: var(--primary); }
        .countdown-box { text-align: center; padding: 20px 0; }
        .days-left { font-size: 3.5rem; font-weight: 800; color: var(--accent); line-height: 1; }
        .sub-text { color: var(--text-light); font-size: 0.9rem; }
        .day-tabs { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; margin-bottom: 15px; -webkit-overflow-scrolling: touch; }
        .day-tab { background: rgba(255,255,255,0.6); border: 1px solid var(--primary); color: var(--primary); padding: 8px 16px; border-radius: 20px; white-space: nowrap; font-size: 0.9rem; }
        .day-tab.active { background: var(--primary); color: white; }
        .timeline-item { border-left: 2px solid var(--secondary); padding-left: 20px; margin-left: 10px; margin-bottom: 25px; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: -6px; top: 0; width: 10px; height: 10px; background: var(--primary); border-radius: 50%; }
        .time-tag { background: var(--bg); color: var(--text-light); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; display: inline-block; margin-bottom: 5px; }
        .location-link { display: inline-block; margin-top: 5px; color: white; background-color: #4285F4; padding: 4px 10px; border-radius: 12px; text-decoration: none; font-size: 0.8rem; }
        .link-btn { display: inline-block; margin-top: 5px; padding: 4px 10px; background-color: #e3f2fd; color: #1976d2; border-radius: 8px; text-decoration: none; font-size: 0.8rem; border: 1px solid #bbdefb; }
        .link-input { width: 100%; margin-top: 5px; padding: 6px; border: 1px solid #ddd; border-radius: 5px; font-size: 0.8rem; background: #fafafa; }
        
        /* åœ–ç‰‡é è¦½ */
        .img-preview { width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-top: 10px; background-color: #eee; display: flex; align-items: center; justify-content: center; color: #999; overflow: hidden; position: relative; }
        .img-preview img { width: 100%; height: 100%; object-fit: cover; cursor: zoom-in; } 
        
        /* ç‡ˆç®± Modal */
        .modal { display: none; position: fixed; z-index: 3000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.95); justify-content: center; align-items: center; animation: fadeIn 0.2s; }
        .modal-content { max-width: 100%; max-height: 100%; object-fit: contain; }
        .modal-close { position: absolute; top: 20px; right: 30px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 3001; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        .file-input { display: none; }
        .upload-btn { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.5); color: white; padding: 5px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; pointer-events: auto; }
        
        .todo-item { display: flex; align-items: center; padding: 10px 0; border-bottom: 1px dashed #eee; }
        .todo-item input[type="checkbox"] { margin-right: 10px; accent-color: var(--primary); }
        .todo-text { flex: 1; outline: none; }
        .delete-btn { color: #ff6b6b; margin-left: 10px; cursor: pointer; }
        .weather-widget { display: flex; justify-content: space-between; align-items: center; background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%); color: white; border-radius: 16px; padding: 20px; margin-bottom: 20px; }
        .clothes-tips { background: #fff; padding: 15px; border-radius: 12px; font-size: 0.9rem; margin-top: 10px; border-left: 4px solid var(--accent); }
        .ticket-btn { background: var(--accent); color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.9rem; margin-top: 5px; cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
        .editable-area { border: 1px dashed #ccc; padding: 10px; border-radius: 8px; min-height: 100px; background: #fafafa; outline: none; }
        .editable-area:focus { background: white; border-color: var(--primary); }
        [contenteditable="true"] { outline: none; border-bottom: 1px dashed #ccc; }

        /* ç·¨è¼¯èˆ‡ç§»å‹•æŒ‰éˆ•æ¨£å¼ */
        .edit-controls { text-align: right; margin-bottom: 10px; }
        .btn-small { background: var(--text-light); color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; cursor: pointer; }
        .move-controls { text-align: right; margin-top: 5px; }
        .move-btn { background: #b0b0b0; margin-left: 2px; }
        
        /* å¤©æ°£é€£çµæŒ‰éˆ• */
        .ios-weather-btn {
            display: block;
            text-align: center;
            background: rgba(255,255,255,0.8);
            color: #007aff;
            text-decoration: none;
            padding: 10px;
            border-radius: 12px;
            margin-bottom: 15px;
            font-weight: bold;
            border: 1px solid #cce5ff;
        }

        .page { display: none; }
        .page.active { display: block; }
        #sync-status { position: fixed; top: 10px; right: 10px; background: rgba(0,0,0,0.6); color: white; padding: 5px 10px; border-radius: 20px; font-size: 0.7rem; z-index: 2000; pointer-events: none; }
    </style>
</head>
<body>

<div id="sync-status">é€£ç·šä¸­...</div>
<header id="header-title">2026 å†°é›ªä¹‹æ—… â„ï¸</header>

<main>
    <!-- 1. é¦–é  -->
    <div id="home" class="page active">
        <div class="card countdown-box">
            <div class="sub-text">è·é›¢ 2026/1/5 å‡ºç™¼é‚„æœ‰</div>
            <div class="days-left" id="countdown-display">--</div>
            <div class="sub-text">å¤©</div>
            <div style="margin-top: 10px; font-weight: bold; color: var(--primary);" id="today-date"></div>
        </div>
        <div class="card">
            <h3>â˜ï¸ å“ˆçˆ¾æ¿±ç¾åœ¨å¤©æ°£</h3>
            <div id="weather-api-display">è¼‰å…¥ä¸­...</div>
            <div class="clothes-tips" style="margin-top:15px; background:#f9f9f9;">
                <strong>ğŸ§¥ ç©¿æ­æŒ‡å— (1æœˆé æ¸¬):</strong><br>
                æ°£æº«ç´„ -20Â°C è‡³ -30Â°Cã€‚<br>
                ä¸Šèº«ï¼šä¿æš–å…§è¡£+ç¾Šæ¯›è¡«+ç¾½çµ¨èƒŒå¿ƒ+é•·ç‰ˆç¾½çµ¨(é˜²é¢¨é˜²æ°´)ã€‚<br>
                ä¸‹èº«ï¼šä¿æš–è¤²(åŠ çµ¨)+é˜²é¢¨æ»‘é›ªè¤²ã€‚<br>
                é…ä»¶ï¼šé›·é‹’å¸½(è­·è€³)ã€åœå·¾ã€è§¸æ§æ‰‹å¥—ã€ç¾Šæ¯›è¥ªã€é›ªåœ°é´(é˜²æ»‘)ã€æš–å¯¶å¯¶ã€‚
            </div>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>ğŸ“ é‡é»å¾…è¾¦ (åŒæ­¥)</h3>
                <button class="btn-small" onclick="addTodo()">+</button>
            </div>
            <div id="todo-list">è¼‰å…¥è³‡æ–™ä¸­...</div>
        </div>
        <div class="card" style="border: 2px solid var(--accent);">
            <h3>ğŸŸï¸ æ¶ç¥¨æé†’</h3>
            <div class="timeline-item"><div class="time-tag">12/24 10:00</div><br><b>å“ˆçˆ¾æ¿±è¥¿ -> é•·ç™½å±±</b><br><button class="ticket-btn" onclick="addToCalendar('æ¶é«˜éµç¥¨:å“ˆçˆ¾æ¿±-é•·ç™½å±±', '2025-12-24T10:00:00', '2025-12-24T10:30:00', '12306 App')">ğŸ“… åŠ å…¥æ—¥æ›†</button></div>
            <div class="timeline-item"><div class="time-tag">12/24 18:00</div><br><b>é•·ç™½å±±æ™¯å€é–€ç¥¨ (1/8å…¥åœ’)</b><br><button class="ticket-btn" onclick="addToCalendar('æ¶æ™¯å€ç¥¨:é•·ç™½å±±1/8', '2025-12-24T18:00:00', '2025-12-24T18:30:00', 'å¾®ä¿¡å°ç¨‹å¼: é•·ç™½å±±')">ğŸ“… åŠ å…¥æ—¥æ›†</button></div>
            <div class="timeline-item"><div class="time-tag">12/25 18:00</div><br><b>é•·ç™½å±±æ™¯å€é–€ç¥¨ (1/9å…¥åœ’)</b><br><button class="ticket-btn" onclick="addToCalendar('æ¶æ™¯å€ç¥¨:é•·ç™½å±±1/9', '2025-12-25T18:00:00', '2025-12-25T18:30:00', 'å¾®ä¿¡å°ç¨‹å¼: é•·ç™½å±±')">ğŸ“… åŠ å…¥æ—¥æ›†</button></div>
            <!-- æ›´æ–°æ¶ç¥¨æ™‚é–“ç‚º 16:30 -->
            <div class="timeline-item"><div class="time-tag">12/27 16:30</div><br><b>é•·ç™½å±± -> é•·æ˜¥</b><br><button class="ticket-btn" onclick="addToCalendar('æ¶é«˜éµç¥¨:é•·ç™½å±±-é•·æ˜¥', '2025-12-27T16:30:00', '2025-12-27T17:00:00', '12306 App')">ğŸ“… åŠ å…¥æ—¥æ›†</button></div>
        </div>
    </div>

    <!-- 2. è¡Œç¨‹è¡¨ -->
    <div id="itinerary" class="page">
        <div class="day-tabs" id="day-tabs"></div>
        <div class="edit-controls">
            <button class="btn-small" onclick="toggleEditMode()" id="edit-mode-btn">âœï¸ ç·¨è¼¯è¡Œç¨‹</button>
        </div>
        <div id="itinerary-content">è¼‰å…¥è³‡æ–™ä¸­...</div>
    </div>

    <!-- 3. ä½å®¿ (å·²æ›´æ–°é€£çµ) -->
    <div id="hotels" class="page">
        <div class="card">
            <h3>ğŸ¨ Day 0-6 (1/4-10) å“ˆçˆ¾æ¿±</h3>
            <h4>æ˜Ÿç¨‹é…’åº—ï¼ˆå“ˆå°”æ»¨åœ°é“ç«™åº—ï¼‰</h4>
            <a href="https://surl.amap.com/4K0Gd5X1p6hx" target="_blank" class="location-link">ğŸš™ é«˜å¾·åœ°åœ–å°èˆª</a>
        </div>
        <div class="card">
            <h3>ğŸ¡ Day 7-9 (1/10-12) é•·ç™½å±±</h3>
            <h4>é’ç¦¾æ°‘å®¿ï¼ˆåŒ—å¡é›†æ•£ä¸­å¿ƒåº—ï¼‰</h4>
            <a href="https://surl.amap.com/4PKVpXLS9qA" target="_blank" class="location-link">ğŸš™ é«˜å¾·åœ°åœ–å°èˆª</a>
        </div>
        <div class="card">
            <h3>ğŸ¨ Day 10-11 (1/13-14) é•·æ˜¥</h3>
            <h4>æ±‰åº­é…’åº—ï¼ˆé•¿æ˜¥ç«è½¦ç«™åº—ï¼‰</h4>
            <a href="https://surl.amap.com/56Wy1RHCeav" target="_blank" class="location-link">ğŸš™ é«˜å¾·åœ°åœ–å°èˆª</a>
        </div>
    </div>

    <!-- 4. å¤©æ°£ -->
    <div id="weather-info" class="page">
        <div class="weather-widget"><div><h2 style="color:white; margin:0;">å“ˆçˆ¾æ¿±</h2><span id="weather-temp-harbin" style="font-size:2.5rem; font-weight:bold;">--Â°</span></div><div style="text-align:right;"><div id="weather-desc-harbin">--</div><div>æ¿•åº¦: <span id="weather-hum-harbin">--</span>%</div></div></div>
        
        <!-- æ–°å¢ iOS å¤©æ°£é€£çµ -->
        <a href="weather://" class="ios-weather-btn">ğŸŒ¤ é–‹å•Ÿ iOS å¤©æ°£ App</a>
        
        <div class="card"><div style="display:flex; justify-content:space-between; align-items:center;"><h3>ğŸ§£ è£å‚™æª¢æŸ¥ (åŒæ­¥)</h3><button class="btn-small" onclick="saveToCloud('packing', document.getElementById('packing-list').innerHTML)">ğŸ’¾ æ‰‹å‹•ä¿å­˜</button></div><div class="sub-text">(é»æ“Šç·¨è¼¯ï¼Œè‡ªå‹•åŒæ­¥å¯èƒ½ç¨æœ‰å»¶é²)</div><div id="packing-list" class="editable-area" contenteditable="true">è¼‰å…¥ä¸­...</div></div>
    </div>

    <!-- 5. å‚™å¿˜ -->
    <div id="backup" class="page">
        <div class="card"><div style="display:flex; justify-content:space-between; align-items:center;"><h3>ğŸ“‚ å‚™é¸è¡Œç¨‹ / ç­†è¨˜ (åŒæ­¥)</h3><button class="btn-small" onclick="saveToCloud('backup', document.getElementById('backup-list').innerHTML)">ğŸ’¾ æ‰‹å‹•ä¿å­˜</button></div><div id="backup-list" class="editable-area" contenteditable="true">è¼‰å…¥ä¸­...</div></div>
        <div class="card"><div style="display:flex; justify-content:space-between; align-items:center;"><h3>ğŸ”— å¯¦ç”¨é€£çµ (åŒæ­¥)</h3><button class="btn-small" onclick="saveToCloud('links', document.getElementById('useful-links').innerHTML)">ğŸ’¾ æ‰‹å‹•ä¿å­˜</button></div><div id="useful-links" class="editable-area" contenteditable="true">è¼‰å…¥ä¸­...</div></div>
    </div>
</main>

<!-- åœ–ç‰‡ç‡ˆç®± Modal -->
<div id="imgModal" class="modal" onclick="closeModal()">
    <span class="modal-close">&times;</span>
    <img class="modal-content" id="modalImg">
</div>

<nav>
    <a href="#" class="nav-item active" onclick="switchTab('home', this)"><div class="nav-icon">ğŸ </div><div>é¦–é </div></a>
    <a href="#" class="nav-item" onclick="switchTab('itinerary', this)"><div class="nav-icon">ğŸ“…</div><div>è¡Œç¨‹</div></a>
    <a href="#" class="nav-item" onclick="switchTab('weather-info', this)"><div class="nav-icon">â„ï¸</div><div>å¤©æ°£</div></a>
    <a href="#" class="nav-item" onclick="switchTab('hotels', this)"><div class="nav-icon">ğŸ¨</div><div>ä½å®¿</div></a>
    <a href="#" class="nav-item" onclick="switchTab('backup', this)"><div class="nav-icon">ğŸ“‹</div><div>å‚™å¿˜</div></a>
</nav>

<script>
    // --- 1. è³‡æ–™èˆ‡é è¨­å€¼ ---
    const defaultData = {
        todos: [
            { text: "è²·æš–å¯¶å¯¶ (å¤§é‡)", done: false },
            { text: "è¨‚é«˜éµç¥¨ (12/24)", done: false }
        ],
        packing: `<ul style="padding-left:20px;line-height:1.8;"><li>ç™¼ç†±è¡£ x3 (Uniqlo Ultra Warmæ¨è–¦)</li><li>ç¾Šæ¯›è¥ª (å¤šå‚™å¹¾é›™)</li><li>æ»‘é›ªæ‰‹å¥— (ä¸€èˆ¬æ‰‹å¥—æ²’ç”¨)</li><li>å¢¨é¡ (é›ªç›²ç—‡é é˜²)</li><li>è¡Œå‹•é›»æº + æš–å¯¶å¯¶è²¼æ‰‹æ©Ÿ (ä½æº«æ‰é›»å¿«)</li><li>ä¿æº«æ¯ (æ½‘æ°´æˆå†°ç”¨ / å–ç†±æ°´)</li><li>é¢è†œ / èº«é«”ä¹³ (æ¥µåº¦ä¹¾ç‡¥)</li><li>é˜²æ°´é˜²æ»‘é›ªåœ°é´</li></ul>`,
        backup: `<ul><li>ç¾é£Ÿå‚™é¸ï¼šé“å¤–å€è€å­—è™Ÿ</li><li>æ™¯é»å‚™é¸ï¼šå“ˆçˆ¾æ¿±å¤§åŠ‡é™¢ (å¤–è§€æ‹ç…§)</li><li>é•·ç™½å±±å‚™æ¡ˆï¼šå¦‚æœå¤©æ± ä¸é–‹ï¼Œå»åœ°ä¸‹æ£®æ—</li><li>é•·æ˜¥ï¼šé€™æœ‰å±± (å•†å ´)</li></ul>`,
        links: `<p><b>é•·ç™½å±±æ¶ç¥¨:</b><br>å¾®ä¿¡æœå°‹å°ç¨‹å¼ã€Œé•¿ç™½å±±ã€(#å°ç¨‹åº://é•¿ç™½å±±/wyxIYIegJjagaJv)</p><p><b>å°ç´…æ›¸æ”»ç•¥:</b><br>ä¸­å¤®å¤§è¡—æ”»ç•¥ <a href="http://xhslink.com/o/3fyzVg48HHu" target="_blank">é»æ“ŠæŸ¥çœ‹</a></p>`,
        itinerary: [
            { day: "Day 0", date: "1/4 (æ—¥)", location: "å“ˆçˆ¾æ¿±", items: [{ time: "17:00", text: "è½åœ°å“ˆçˆ¾æ¿± âœˆï¸", img: "", link: "" }] },
            { day: "Day 1", date: "1/5 (ä¸€)", location: "å“ˆçˆ¾æ¿±", items: [{ time: "ä¸‹åˆ", text: "â„ï¸ å†°é›ªå¤§ä¸–ç•Œ (å¿…å»)", img: "", link: "" }] },
            { day: "Day 2", date: "1/6 (äºŒ)", location: "å“ˆçˆ¾æ¿±", items: [{ time: "ä¸­åˆ", text: "ä¸­å¤®å¤§è¡—", img: "", link: "http://xhslink.com/o/3fyzVg48HHu" }] },
            { day: "Day 3", date: "1/7 (ä¸‰)", location: "ç§»å‹•æ—¥", items: [{ time: "07:18", text: "é«˜éµ -> é•·ç™½å±±", img: "", link: "" }] },
            { day: "Day 4", date: "1/8 (å››)", location: "é•·ç™½å±±", items: [{ time: "å…¨æ—¥", text: "ğŸ”ï¸ é•·ç™½å±±åŒ—å¡", img: "", link: "" }] },
            { day: "Day 5", date: "1/9 (äº”)", location: "é•·ç™½å±±", items: [{ time: "09:00", text: "é›ªå¶º (é¤µé¹¿)", img: "", link: "" }] },
            { day: "Day 6", date: "1/10 (å…­)", location: "é•·æ˜¥", items: [{ time: "ä¸‹åˆ", text: "é«˜éµ -> é•·æ˜¥", img: "", link: "" }] }
        ]
    };

    let localData = JSON.parse(JSON.stringify(defaultData)); 
    let isEditMode = false;
    let dbReady = false;

    // --- 2. Firebase åŒæ­¥æ ¸å¿ƒ ---
    window.addEventListener('firebase-ready', () => {
        const db = window.db;
        const ref = window.ref;
        const onValue = window.onValue;

        onValue(ref(db, 'trip2026'), (snapshot) => {
            const val = snapshot.val();
            document.getElementById('sync-status').innerText = "ğŸŸ¢ å·²é€£ç·šé›²ç«¯";
            document.getElementById('sync-status').style.background = "rgba(0,128,0,0.6)";
            dbReady = true;

            if (val) {
                localData = val;
                if(!localData.itinerary) localData.itinerary = defaultData.itinerary;
                if(!localData.todos) localData.todos = [];
                renderAll();
                console.log("å·²å¾é›²ç«¯åŒæ­¥è³‡æ–™");
            } else {
                console.log("è³‡æ–™åº«ç‚ºç©ºï¼Œå¯«å…¥é è¨­å€¼");
                window.set(ref(db, 'trip2026'), defaultData);
            }
        }, (error) => {
             console.error(error);
             document.getElementById('sync-status').innerText = "ğŸ”´ é€£ç·šå¤±æ•—";
             document.getElementById('sync-status').style.background = "rgba(255,0,0,0.6)";
        });
    });

    // å¯«å…¥é›²ç«¯
    function pushToCloud() {
        if(!dbReady) return;
        document.getElementById('sync-status').innerText = "ğŸŸ¡ åŒæ­¥ä¸­...";
        document.getElementById('sync-status').style.background = "rgba(255,165,0,0.6)";
        
        window.set(window.ref(window.db, 'trip2026'), localData).then(() => {
             document.getElementById('sync-status').innerText = "ğŸŸ¢ å·²åŒæ­¥";
             document.getElementById('sync-status').style.background = "rgba(0,128,0,0.6)";
        }).catch((err) => {
             document.getElementById('sync-status').innerText = "ğŸ”´ åŒæ­¥å¤±æ•—";
        });
    }

    window.saveToCloud = function(key, content) {
        localData[key] = content;
        pushToCloud();
    }

    // --- 3. æ¸²æŸ“èˆ‡é‚è¼¯ ---

    function init() {
        renderCountdown();
        fetchWeather();
        const now = new Date();
        document.getElementById('today-date').innerText = "ä»Šå¤©æ˜¯ " + now.toLocaleDateString('zh-TW', { month: 'long', day: 'numeric', weekday: 'long' });
        renderAll();
    }

    function renderAll() {
        renderTodos();
        renderItineraryTabs();
        const currentTab = document.querySelector('.day-tab.active');
        const dayIndex = currentTab ? Array.from(document.querySelectorAll('.day-tab')).indexOf(currentTab) : 0;
        renderItineraryContent(dayIndex);
        
        if(document.activeElement.id !== 'packing-list') document.getElementById('packing-list').innerHTML = localData.packing;
        if(document.activeElement.id !== 'backup-list') document.getElementById('backup-list').innerHTML = localData.backup;
        if(document.activeElement.id !== 'useful-links') document.getElementById('useful-links').innerHTML = localData.links;
    }

    // Todo Logic
    function renderTodos() {
        const list = document.getElementById('todo-list');
        list.innerHTML = '';
        if(localData.todos.length === 0) list.innerHTML = '<div style="color:#999; text-align:center; padding:10px;">é»æ“Š + æ–°å¢å¾…è¾¦</div>';
        
        localData.todos.forEach((todo, index) => {
            const div = document.createElement('div');
            div.className = 'todo-item';
            div.innerHTML = `
                <input type="checkbox" ${todo.done ? 'checked' : ''} onchange="toggleTodo(${index})">
                <span class="todo-text" contenteditable="true" onblur="updateTodoText(${index}, this.innerText)" style="text-decoration: ${todo.done ? 'line-through' : 'none'}; color: ${todo.done ? '#ccc' : 'inherit'}">${todo.text}</span>
                <span class="delete-btn" onclick="deleteTodo(${index})">âœ•</span>
            `;
            list.appendChild(div);
        });
    }
    window.addTodo = function() { localData.todos.push({ text: "æ–°äº‹é …", done: false }); pushToCloud(); }
    window.toggleTodo = function(idx) { localData.todos[idx].done = !localData.todos[idx].done; pushToCloud(); }
    window.updateTodoText = function(idx, txt) { localData.todos[idx].text = txt; pushToCloud(); }
    window.deleteTodo = function(idx) { if(confirm('åˆªé™¤?')) { localData.todos.splice(idx, 1); pushToCloud(); } }

    // Itinerary Logic
    function renderItineraryTabs() {
        const container = document.getElementById('day-tabs');
        if(container.children.length === 0) {
            container.innerHTML = '';
            localData.itinerary.forEach((day, index) => {
                const btn = document.createElement('button');
                btn.className = `day-tab ${index === 0 ? 'active' : ''}`;
                btn.innerText = day.day;
                btn.onclick = () => {
                    document.querySelectorAll('.day-tab').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderItineraryContent(index);
                };
                container.appendChild(btn);
            });
        }
    }

    function renderItineraryContent(dayIndex) {
        const dayData = localData.itinerary[dayIndex];
        const container = document.getElementById('itinerary-content');
        container.dataset.currentIndex = dayIndex;
        
        let html = `
            <div class="card" style="border-top: 5px solid var(--primary);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 contenteditable="${isEditMode}" onblur="updateDayTitle(${dayIndex}, 'location', this.innerText)">${dayData.location}</h2>
                    <span style="color:var(--text-light); font-weight:bold;">${dayData.date}</span>
                </div>
                <div style="margin-top:10px;">
        `;

        dayData.items.forEach((item, itemIndex) => {
            html += `
                <div class="timeline-item">
                    <div class="time-tag" contenteditable="${isEditMode}" onblur="updateItem(${dayIndex}, ${itemIndex}, 'time', this.innerText)">${item.time}</div>
                    <div style="font-size:1.1rem; margin-bottom:5px;" contenteditable="${isEditMode}" onblur="updateItem(${dayIndex}, ${itemIndex}, 'text', this.innerText)">${item.text}</div>
                    ${isEditMode 
                        ? `<input type="text" class="link-input" placeholder="é€£çµ (http://...)" value="${item.link||''}" onblur="updateItem(${dayIndex}, ${itemIndex}, 'link', this.value)">` 
                        : (item.link ? `<a href="${item.link}" target="_blank" class="link-btn">ğŸ”— é–‹å•Ÿé€£çµ</a>` : '')
                    }
                    
                    ${isEditMode ? `
                        <div class="move-controls">
                            <button class="btn-small move-btn" onclick="moveItem(${dayIndex}, ${itemIndex}, -1)">â¬†ï¸</button>
                            <button class="btn-small move-btn" onclick="moveItem(${dayIndex}, ${itemIndex}, 1)">â¬‡ï¸</button>
                            <button class="btn-small" style="background:#ff6b6b; margin-left:5px;" onclick="deleteItineraryItem(${dayIndex}, ${itemIndex})">åˆªé™¤</button>
                        </div>
                    ` : ''}

                    <div class="img-preview">
                        ${item.img 
                            ? `<img src="${item.img}" onclick="openModal('${item.img}')" alt="é»æ“Šæ”¾å¤§">` 
                            : '<span>æš«ç„¡åœ–ç‰‡</span>'
                        }
                        ${isEditMode ? `<label class="upload-btn">ğŸ“· <input type="file" class="file-input" accept="image/*" onchange="uploadImage(this, ${dayIndex}, ${itemIndex})"></label>` : ''}
                    </div>
                </div>
            `;
        });

        if(isEditMode) html += `<button class="btn-small" style="width:100%; margin-top:10px; background:var(--secondary);" onclick="addItineraryItem(${dayIndex})">+ æ–°å¢è¡Œç¨‹</button>`;
        html += `</div></div>`;
        container.innerHTML = html;
    }

    // Itinerary Updates
    window.toggleEditMode = function() {
        isEditMode = !isEditMode;
        document.getElementById('edit-mode-btn').innerText = isEditMode ? "âœ… å®Œæˆç·¨è¼¯" : "âœï¸ ç·¨è¼¯è¡Œç¨‹";
        renderItineraryContent(parseInt(document.getElementById('itinerary-content').dataset.currentIndex || 0));
    }
    window.updateItem = function(d, i, k, v) { localData.itinerary[d].items[i][k] = v; pushToCloud(); }
    window.updateDayTitle = function(d, k, v) { localData.itinerary[d][k] = v; pushToCloud(); }
    window.addItineraryItem = function(d) { localData.itinerary[d].items.push({time:"æ™‚é–“", text:"æ–°æ´»å‹•", img:"", link:""}); pushToCloud(); }
    window.deleteItineraryItem = function(d, i) { if(confirm("ç¢ºå®šåˆªé™¤?")){ localData.itinerary[d].items.splice(i,1); pushToCloud(); } }
    
    // Move Items Function
    window.moveItem = function(dayIdx, itemIdx, direction) {
        const items = localData.itinerary[dayIdx].items;
        if (direction === -1 && itemIdx > 0) {
            [items[itemIdx], items[itemIdx-1]] = [items[itemIdx-1], items[itemIdx]];
            pushToCloud();
            renderItineraryContent(dayIdx);
        } else if (direction === 1 && itemIdx < items.length - 1) {
            [items[itemIdx], items[itemIdx+1]] = [items[itemIdx+1], items[itemIdx]];
            pushToCloud();
            renderItineraryContent(dayIdx);
        }
    }

    // Image Upload (High Quality: 1024px, 0.8)
    window.uploadImage = function(input, d, i) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 1024; 
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    localData.itinerary[d].items[i].img = canvas.toDataURL('image/jpeg', 0.8); 
                    pushToCloud();
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Lightbox Function
    window.openModal = function(src) {
        const modal = document.getElementById('imgModal');
        const modalImg = document.getElementById('modalImg');
        modal.style.display = "flex";
        modalImg.src = src;
    }
    window.closeModal = function() {
        document.getElementById('imgModal').style.display = "none";
    }

    // Helpers
    window.switchTab = function(pid, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pid).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
        window.scrollTo(0,0);
    }
    function renderCountdown() {
        const diff = new Date("2026-01-05") - new Date();
        const days = Math.ceil(diff / (86400000));
        document.getElementById('countdown-display').innerText = days > 0 ? days : (days > -7 ? "æ—…ç¨‹ä¸­" : "å·²çµæŸ");
    }
    async function fetchWeather() {
        try {
            const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=45.75&longitude=126.63&current_weather=true`);
            const d = await res.json();
            document.getElementById('weather-api-display').innerHTML = `<span style="font-size:1.5rem; font-weight:bold;">${d.current_weather.temperature}Â°C</span>`;
            document.getElementById('weather-temp-harbin').innerText = `${d.current_weather.temperature}Â°`;
            document.getElementById('weather-desc-harbin').innerText = "å¤©æ°£ç‹€æ³ä»£ç¢¼: " + d.current_weather.weathercode;
        } catch(e) { console.log(e); }
    }
    window.addToCalendar = function(title, start, end, desc) {
         const blob = new Blob([`BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nDTSTART:${start.replace(/[-:]/g,"").split('.')[0]}\nDTEND:${end.replace(/[-:]/g,"").split('.')[0]}\nSUMMARY:${title}\nDESCRIPTION:${desc}\nEND:VEVENT\nEND:VCALENDAR`], { type: 'text/calendar' });
         const link = document.createElement('a');
         link.href = URL.createObjectURL(blob);
         link.download = 'trip_event.ics';
         link.click();
    }

    init();
</script>

</body>
</html>
