<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>å“ˆçˆ¾æ¿± & é•·ç™½å±± 2026</title>
    <style>
        :root {
            --primary: #C19A6B; /* å¡å…¶æ·±è‰² */
            --secondary: #E6C288; /* æ·ºå¡å…¶ */
            --bg: #FFF8E7; /* ç±³ç™½åº•è‰² */
            --card-bg: #FFFFFF;
            --text: #5C4033; /* æ·±è¤æ–‡å­— */
            --text-light: #8B7355;
            --accent: #D2691E; /* é‡é»è‰² */
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* æ¨™é¡Œåˆ— */
        header {
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
            padding: 50px 20px 15px;
            color: white;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 2px 10px rgba(193, 154, 107, 0.3);
            flex-shrink: 0;
        }

        /* å…§å®¹å€ */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: calc(80px + var(--safe-area-bottom));
        }

        /* åº•éƒ¨å°èˆª */
        nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: var(--card-bg);
            border-top: 1px solid #eee;
            display: flex;
            justify-content: space-around;
            padding: 10px 0 calc(10px + var(--safe-area-bottom));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-light);
            text-decoration: none;
            flex: 1;
        }

        .nav-item.active {
            color: var(--primary);
            font-weight: bold;
        }

        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        /* å¡ç‰‡æ¨£å¼ */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(92, 64, 51, 0.08);
            position: relative;
        }

        h2, h3 { margin-top: 0; color: var(--primary); }
        
        /* å€’æ•¸è¨ˆæ™‚ */
        .countdown-box {
            text-align: center;
            padding: 20px 0;
        }
        .days-left {
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--accent);
            line-height: 1;
        }
        .sub-text { color: var(--text-light); font-size: 0.9rem; }

        /* è¡Œç¨‹è¡¨ */
        .day-tabs {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding-bottom: 10px;
            margin-bottom: 15px;
            -webkit-overflow-scrolling: touch;
        }
        .day-tab {
            background: rgba(255,255,255,0.6);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 8px 16px;
            border-radius: 20px;
            white-space: nowrap;
            font-size: 0.9rem;
        }
        .day-tab.active {
            background: var(--primary);
            color: white;
        }
        
        .timeline-item {
            border-left: 2px solid var(--secondary);
            padding-left: 20px;
            margin-left: 10px;
            margin-bottom: 25px;
            position: relative;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 0;
            width: 10px;
            height: 10px;
            background: var(--primary);
            border-radius: 50%;
        }
        .time-tag {
            background: var(--bg);
            color: var(--text-light);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            display: inline-block;
            margin-bottom: 5px;
        }
        .location-link {
            display: inline-block;
            margin-top: 5px;
            color: white;
            background-color: #4285F4; /* Amap Blueish */
            padding: 4px 10px;
            border-radius: 12px;
            text-decoration: none;
            font-size: 0.8rem;
        }

        /* é€£çµæ¨£å¼ */
        .link-btn {
            display: inline-block;
            margin-top: 5px;
            padding: 4px 10px;
            background-color: #e3f2fd;
            color: #1976d2;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.8rem;
            border: 1px solid #bbdefb;
        }
        .link-input {
            width: 100%;
            margin-top: 5px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.8rem;
            background: #fafafa;
        }
        
        /* åœ–ç‰‡ä¸Šå‚³é è¦½ */
        .img-preview {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-top: 10px;
            background-color: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            overflow: hidden;
            position: relative;
        }
        .img-preview img { width: 100%; height: 100%; object-fit: cover; }
        .file-input { display: none; }
        .upload-btn {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 5px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        /* å¾…è¾¦äº‹é … */
        .todo-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }
        .todo-item input[type="checkbox"] { margin-right: 10px; accent-color: var(--primary); }
        .todo-text { flex: 1; outline: none; }
        .delete-btn { color: #ff6b6b; margin-left: 10px; cursor: pointer; }

        /* å¤©æ°£ */
        .weather-widget {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%);
            color: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .clothes-tips {
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            font-size: 0.9rem;
            margin-top: 10px;
            border-left: 4px solid var(--accent);
        }

        /* æ¶ç¥¨æŒ‰éˆ• */
        .ticket-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 5px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        /* ç·¨è¼¯å€åŸŸæ¨£å¼ */
        .editable-area {
            border: 1px dashed #ccc;
            padding: 10px;
            border-radius: 8px;
            min-height: 100px;
            background: #fafafa;
            outline: none;
        }
        .editable-area:focus {
            background: white;
            border-color: var(--primary);
        }

        /* ç·¨è¼¯æ¨¡å¼ (è¡¨æ ¼) */
        [contenteditable="true"] {
            outline: none;
            border-bottom: 1px dashed #ccc;
        }
        .edit-controls {
            text-align: right;
            margin-bottom: 10px;
        }
        .btn-small {
            background: var(--text-light);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .page { display: none; }
        .page.active { display: block; }

    </style>
</head>
<body>

<header id="header-title">2026 å†°é›ªä¹‹æ—… â„ï¸</header>

<main>
    <!-- 1. é¦–é  -->
    <div id="home" class="page active">
        <div class="card countdown-box">
            <div class="sub-text">è·é›¢ 2026/1/5 å‡ºç™¼é‚„æœ‰</div>
            <div class="days-left" id="countdown-display">--</div>
            <div class="sub-text">å¤©</div>
            <div style="margin-top: 10px; font-weight: bold; color: var(--primary);" id="today-date"></div>
        </div>

        <div class="card">
            <h3>â˜ï¸ å“ˆçˆ¾æ¿±ç¾åœ¨å¤©æ°£</h3>
            <div id="weather-api-display">è¼‰å…¥ä¸­...</div>
            <div class="clothes-tips" style="margin-top:15px; background:#f9f9f9;">
                <strong>ğŸ§¥ ç©¿æ­æŒ‡å— (1æœˆé æ¸¬):</strong><br>
                æ°£æº«ç´„ -20Â°C è‡³ -30Â°Cã€‚<br>
                ä¸Šèº«ï¼šä¿æš–å…§è¡£+ç¾Šæ¯›è¡«+ç¾½çµ¨èƒŒå¿ƒ+é•·ç‰ˆç¾½çµ¨(é˜²é¢¨é˜²æ°´)ã€‚<br>
                ä¸‹èº«ï¼šä¿æš–è¤²(åŠ çµ¨)+é˜²é¢¨æ»‘é›ªè¤²ã€‚<br>
                é…ä»¶ï¼šé›·é‹’å¸½(è­·è€³)ã€åœå·¾ã€è§¸æ§æ‰‹å¥—ã€ç¾Šæ¯›è¥ªã€é›ªåœ°é´(é˜²æ»‘)ã€æš–å¯¶å¯¶ã€‚
            </div>
        </div>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>ğŸ“ é‡é»å¾…è¾¦</h3>
                <button class="btn-small" onclick="addTodo()">+</button>
            </div>
            <div id="todo-list">
                <!-- Javascript will load todos here -->
            </div>
        </div>
        
        <div class="card" style="border: 2px solid var(--accent);">
            <h3>ğŸŸï¸ æ¶ç¥¨æé†’ (é»æ“ŠåŠ å…¥è¡Œäº‹æ›†)</h3>
            <div class="timeline-item">
                <div class="time-tag">12æœˆ24æ—¥ 10:00 (é è¨ˆ)</div><br>
                <b>å“ˆçˆ¾æ¿±è¥¿ -> é•·ç™½å±±</b> (1/7 07:18è»Šæ¬¡)<br>
                <button class="ticket-btn" onclick="addToCalendar('æ¶é«˜éµç¥¨:å“ˆçˆ¾æ¿±-é•·ç™½å±±', '2025-12-24T10:00:00', '2025-12-24T10:30:00', '12306 App')">ğŸ“… åŠ å…¥æ—¥æ›†</button>
            </div>
            <div class="timeline-item">
                <div class="time-tag">12æœˆ24æ—¥ 18:00</div><br>
                <b>é•·ç™½å±±æ™¯å€é–€ç¥¨ (1/8å…¥åœ’)</b><br>
                <button class="ticket-btn" onclick="addToCalendar('æ¶æ™¯å€ç¥¨:é•·ç™½å±±1/8', '2025-12-24T18:00:00', '2025-12-24T18:30:00', 'å¾®ä¿¡å°ç¨‹å¼: é•·ç™½å±±')">ğŸ“… åŠ å…¥æ—¥æ›†</button>
            </div>
            <div class="timeline-item">
                <div class="time-tag">12æœˆ25æ—¥ 18:00</div><br>
                <b>é•·ç™½å±±æ™¯å€é–€ç¥¨ (1/9å…¥åœ’)</b><br>
                <button class="ticket-btn" onclick="addToCalendar('æ¶æ™¯å€ç¥¨:é•·ç™½å±±1/9', '2025-12-25T18:00:00', '2025-12-25T18:30:00', 'å¾®ä¿¡å°ç¨‹å¼: é•·ç™½å±±')">ğŸ“… åŠ å…¥æ—¥æ›†</button>
            </div>
             <div class="timeline-item">
                <div class="time-tag">12æœˆ27æ—¥ (æ™‚é–“å¾…å®š)</div><br>
                <b>é•·ç™½å±± -> é•·æ˜¥</b> (1/10 è»Šæ¬¡)<br>
                <button class="ticket-btn" onclick="addToCalendar('æ¶é«˜éµç¥¨:é•·ç™½å±±-é•·æ˜¥', '2025-12-27T10:00:00', '2025-12-27T10:30:00', '12306 App')">ğŸ“… åŠ å…¥æ—¥æ›†</button>
            </div>
        </div>
    </div>

    <!-- 2. è¡Œç¨‹è¡¨ -->
    <div id="itinerary" class="page">
        <div class="day-tabs" id="day-tabs">
            <!-- JS Generated -->
        </div>
        
        <div class="edit-controls">
            <button class="btn-small" onclick="toggleEditMode()" id="edit-mode-btn">âœï¸ ç·¨è¼¯è¡Œç¨‹</button>
        </div>

        <div id="itinerary-content">
            <!-- JS Generated Content -->
        </div>
    </div>

    <!-- 3. ä½å®¿ -->
    <div id="hotels" class="page">
        <div class="card">
            <h3>ğŸ¨ Day 0-6 (1/4-10) å“ˆçˆ¾æ¿±</h3>
            <h4>æ˜Ÿç¨‹é…’åº—ï¼ˆå“ˆå°”æ»¨åœ°é“ç«™åº—ï¼‰</h4>
            <p>ğŸ“ å“ˆçˆ¾æ¿±</p>
            <a href="https://uri.amap.com/search?keyword=æ˜Ÿç¨‹é…’åº—(å“ˆå°”æ»¨åœ°é“ç«™åº—)" target="_blank" class="location-link">ğŸš™ é«˜å¾·åœ°åœ–å°èˆª</a>
        </div>
        <div class="card">
            <h3>ğŸ¡ Day 7-9 (1/10-12) é•·ç™½å±±</h3>
            <h4>é’ç¦¾æ°‘å®¿ï¼ˆé•·ç™½å±±åŒ—å¡é›†æ•£ä¸­å¿ƒåº—ï¼‰</h4>
            <p>ğŸ“ å®‰å›¾ç™½å±±è¡—å†°é›ªå°é•‡27å·æ¥¼1å•å…ƒ303å®¤</p>
            <a href="https://uri.amap.com/search?keyword=é•¿ç™½å±±åŒ—å¡é›†æ•£ä¸­å¿ƒ" target="_blank" class="location-link">ğŸš™ é«˜å¾·åœ°åœ–å°èˆª (è‡³é›†æ•£ä¸­å¿ƒ)</a>
        </div>
        <div class="card">
            <h3>ğŸ¨ Day 10-11 (1/13-14) é•·æ˜¥</h3>
            <h4>æ±‰åº­é…’åº—ï¼ˆé•¿æ˜¥ç«è½¦ç«™åº—ï¼‰</h4>
            <p>ğŸ“ é•·æ˜¥ç«è»Šç«™é™„è¿‘</p>
            <a href="https://uri.amap.com/search?keyword=æ±‰åº­é…’åº—(é•¿æ˜¥ç«è½¦ç«™åº—)" target="_blank" class="location-link">ğŸš™ é«˜å¾·åœ°åœ–å°èˆª</a>
        </div>
    </div>

    <!-- 4. å¤©æ°£è³‡è¨Š (è©³ç´°) -->
    <div id="weather-info" class="page">
        <div class="weather-widget">
             <div>
                 <h2 style="color:white; margin:0;">å“ˆçˆ¾æ¿±</h2>
                 <span id="weather-temp-harbin" style="font-size:2.5rem; font-weight:bold;">--Â°</span>
             </div>
             <div style="text-align:right;">
                 <div id="weather-desc-harbin">è¼‰å…¥ä¸­...</div>
                 <div>æ¿•åº¦: <span id="weather-hum-harbin">--</span>%</div>
             </div>
        </div>
        
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>ğŸ§£ è£å‚™æª¢æŸ¥æ¸…å–®</h3>
                <button class="btn-small" onclick="saveContent('packing-list', 'trip_packing')">ğŸ’¾ ä¿å­˜</button>
            </div>
            <div class="sub-text" style="margin-bottom:5px;">(é»æ“Šä¸‹æ–¹æ¸…å–®å³å¯ç›´æ¥ç·¨è¼¯)</div>
            
            <div id="packing-list" class="editable-area" contenteditable="true">
                <!-- é è¨­å…§å®¹ç”± JS å¡«å…… -->
            </div>
        </div>
    </div>

    <!-- 5. å‚™é¸è¡Œç¨‹ -->
    <div id="backup" class="page">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>ğŸ“‚ å‚™é¸è¡Œç¨‹ / ç­†è¨˜</h3>
                <button class="btn-small" onclick="saveContent('backup-list', 'trip_backup')">ğŸ’¾ ä¿å­˜</button>
            </div>
            <div id="backup-list" class="editable-area" contenteditable="true">
                <!-- é è¨­å…§å®¹ç”± JS å¡«å…… -->
            </div>
        </div>
        
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>ğŸ”— å¯¦ç”¨é€£çµ</h3>
                <button class="btn-small" onclick="saveContent('useful-links', 'trip_links')">ğŸ’¾ ä¿å­˜</button>
            </div>
            <div class="sub-text" style="margin-bottom:5px;">(å¯åœ¨æ­¤è²¼ä¸Šå°ç´…æ›¸/å¤§çœ¾é»è©•é€£çµ)</div>
            
            <div id="useful-links" class="editable-area" contenteditable="true">
                <!-- é è¨­å…§å®¹ç”± JS å¡«å…… -->
            </div>
        </div>
    </div>
</main>

<nav>
    <a href="#" class="nav-item active" onclick="switchTab('home', this)">
        <div class="nav-icon">ğŸ </div>
        <div>é¦–é </div>
    </a>
    <a href="#" class="nav-item" onclick="switchTab('itinerary', this)">
        <div class="nav-icon">ğŸ“…</div>
        <div>è¡Œç¨‹</div>
    </a>
    <a href="#" class="nav-item" onclick="switchTab('weather-info', this)">
        <div class="nav-icon">â„ï¸</div>
        <div>å¤©æ°£</div>
    </a>
    <a href="#" class="nav-item" onclick="switchTab('hotels', this)">
        <div class="nav-icon">ğŸ¨</div>
        <div>ä½å®¿</div>
    </a>
    <a href="#" class="nav-item" onclick="switchTab('backup', this)">
        <div class="nav-icon">ğŸ“‹</div>
        <div>å‚™å¿˜</div>
    </a>
</nav>

<script>
    // --- 1. è³‡æ–™èˆ‡åˆå§‹åŒ– ---
    const defaultTodos = [
        { text: "è²·æš–å¯¶å¯¶ (å¤§é‡)", done: false },
        { text: "è¨‚é«˜éµç¥¨ (12/24)", done: false },
        { text: "ä¸‹è¼‰é«˜å¾·åœ°åœ– App", done: false }
    ];

    // é è¨­å…§å®¹ï¼šè£å‚™æ¸…å–®
    const defaultPackingList = `
        <ul style="padding-left:20px; line-height:1.8;">
            <li>ç™¼ç†±è¡£ x3 (Uniqlo Ultra Warmæ¨è–¦)</li>
            <li>ç¾Šæ¯›è¥ª (å¤šå‚™å¹¾é›™)</li>
            <li>æ»‘é›ªæ‰‹å¥— (ä¸€èˆ¬æ‰‹å¥—æ²’ç”¨)</li>
            <li>å¢¨é¡ (é›ªç›²ç—‡é é˜²)</li>
            <li>è¡Œå‹•é›»æº + æš–å¯¶å¯¶è²¼æ‰‹æ©Ÿ (ä½æº«æ‰é›»å¿«)</li>
            <li>ä¿æº«æ¯ (æ½‘æ°´æˆå†°ç”¨ / å–ç†±æ°´)</li>
            <li>é¢è†œ / èº«é«”ä¹³ (æ¥µåº¦ä¹¾ç‡¥)</li>
            <li>é˜²æ°´é˜²æ»‘é›ªåœ°é´</li>
        </ul>`;

    // é è¨­å…§å®¹ï¼šå‚™é¸è¡Œç¨‹
    const defaultBackupNotes = `
        <ul>
            <li>ç¾é£Ÿå‚™é¸ï¼šé“å¤–å€è€å­—è™Ÿ</li>
            <li>æ™¯é»å‚™é¸ï¼šå“ˆçˆ¾æ¿±å¤§åŠ‡é™¢ (å¤–è§€æ‹ç…§)</li>
            <li>é•·ç™½å±±å‚™æ¡ˆï¼šå¦‚æœå¤©æ± ä¸é–‹ï¼Œå»åœ°ä¸‹æ£®æ—</li>
            <li>é•·æ˜¥ï¼šé€™æœ‰å±± (å•†å ´)</li>
        </ul>`;

    // é è¨­å…§å®¹ï¼šå¯¦ç”¨é€£çµ
    const defaultLinks = `
        <p><b>é•·ç™½å±±æ¶ç¥¨:</b><br>å¾®ä¿¡æœå°‹å°ç¨‹å¼ã€Œé•¿ç™½å±±ã€(#å°ç¨‹åº://é•¿ç™½å±±/wyxIYIegJjagaJv)</p>
        <p><b>å°ç´…æ›¸æ”»ç•¥:</b><br>ä¸­å¤®å¤§è¡—æ”»ç•¥ <a href="http://xhslink.com/o/3fyzVg48HHu" target="_blank">é»æ“ŠæŸ¥çœ‹</a></p>
        <p><b>å…¶ä»–:</b><br>åœ¨æ­¤æ–°å¢ä½ çš„é€£çµ...</p>
    `;

    // åˆå§‹åŒ–è¡Œç¨‹è³‡æ–™ (æ–°å¢ link æ¬„ä½)
    const initialItinerary = [
        { 
            day: "Day 0", date: "1/4 (æ—¥)", location: "å“ˆçˆ¾æ¿±", 
            items: [
                { time: "17:00", text: "è½åœ°å“ˆçˆ¾æ¿± âœˆï¸", img: "", link: "" },
                { time: "æ™šä¸Š", text: "æ˜Ÿç¨‹é…’åº— Check-in", img: "", link: "" },
                { time: "æ™šé¤", text: "é…’åº—é™„è¿‘è¦“é£Ÿ (éµé‹ç‡‰/ç‡’çƒ¤?)", img: "", link: "" }
            ]
        },
        { 
            day: "Day 1", date: "1/5 (ä¸€)", location: "å“ˆçˆ¾æ¿±", 
            items: [
                { time: "æ—©ä¸Š", text: "ç´…ç£šæ—©å¸‚ (äººå¤šå¯æ”¹æ—¥)", img: "", link: "" },
                { time: "ä¸Šåˆ", text: "731éƒ¨éšŠç½ªè­‰é™³åˆ—é¤¨ (é¸å»)", img: "", link: "" },
                { time: "ä¸‹åˆ", text: "â„ï¸ å†°é›ªå¤§ä¸–ç•Œ (å¿…å»)", img: "", link: "" },
                { time: "æ™šé¤", text: "å†°é›ªå¤§ä¸–ç•Œå…§æˆ–å¸‚å€", img: "", link: "" }
            ]
        },
        { 
            day: "Day 2", date: "1/6 (äºŒ)", location: "å“ˆçˆ¾æ¿±", 
            items: [
                { time: "æ—©ä¸Š", text: "é“é‡Œèœå¸‚å ´ / å…¶ä»–æ—©å¸‚", img: "", link: "" },
                { time: "ä¸Šåˆ", text: "ç´¢è²äºæ•™å ‚ (æ‹ç…§)", img: "", link: "" },
                { time: "ä¸­åˆ", text: "ä¸­å¤®å¤§è¡— (é¦¬è¿­çˆ¾å†°æ£ã€ç…™å›ªéºµåŒ…)", img: "", link: "http://xhslink.com/o/3fyzVg48HHu" },
                { time: "ä¸‹åˆ", text: "é˜²æ´ªç´€å¿µå¡” -> æ¾èŠ±æ±Ÿéµè·¯æ©‹", img: "", link: "" },
                { time: "å‚æ™š", text: "å·´æ´›å…‹é¢¨æƒ…è¡—", img: "", link: "" }
            ]
        },
        { 
            day: "Day 3", date: "1/7 (ä¸‰)", location: "ç§»å‹•æ—¥", 
            items: [
                { time: "06:30", text: "å‡ºé–€ï¼å‰å¾€å“ˆçˆ¾æ¿±è¥¿ç«™", img: "", link: "" },
                { time: "07:18", text: "é«˜éµ D123 (ç¯„ä¾‹) -> é•·ç™½å±±", img: "", link: "" },
                { time: "ä¸‹åˆ", text: "é›ªçµ¨èŠ±é¦´é¹¿å…¬åœ’ (å†°ç€‘å¸ƒ)", img: "", link: "" },
                { time: "å‚æ™š", text: "é›²é ‚å¸‚é›† / ç¾äººæ¾å…¬åœ’", img: "", link: "" }
            ]
        },
        { 
            day: "Day 4", date: "1/8 (å››)", location: "é•·ç™½å±±", 
            items: [
                { time: "å…¨æ—¥", text: "ğŸ”ï¸ é•·ç™½å±±åŒ—å¡æ™¯å€", img: "", link: "" },
                { time: "é‡é»", text: "å¤©æ±  (çœ‹é‹æ°£)", img: "", link: "" },
                { time: "æ™¯é»", text: "é•·ç™½ç€‘å¸ƒã€ç¶ æ·µæ½­", img: "", link: "" },
                { time: "æ™šé¤", text: "è¦ªè¦ªçƒ¤è‚‰ / æœé®®æ—ç¾é£Ÿ", img: "", link: "" }
            ]
        },
        { 
            day: "Day 5", date: "1/9 (äº”)", location: "é•·ç™½å±±", 
            items: [
                { time: "09:00", text: "å‡ºç™¼å»é›ªå¶º (åŒ…è»Šç´„$168)", img: "", link: "" },
                { time: "å…¨æ—¥", text: "é›ªå¶º (é¤µé¹¿ã€é›ªåœ°æ‘©æ‰˜)", img: "", link: "" },
                { time: "æ™šä¸Š", text: "å›é®ä¸Šåƒæ­£è«‡ç‚¸é›", img: "", link: "" }
            ]
        },
        { 
            day: "Day 6", date: "1/10 (å…­)", location: "é•·æ˜¥", 
            items: [
                { time: "æ—©ä¸Š", text: "ç¡å€‹å¥½è¦º / é™„è¿‘é€›é€›", img: "", link: "" },
                { time: "ä¸‹åˆ", text: "é«˜éµ -> é•·æ˜¥", img: "", link: "" },
                { time: "æ™šä¸Š", text: "å…¥ä½æ¼¢åº­ (é•·æ˜¥ç«™)", img: "", link: "" }
            ]
        }
    ];

    let todos = JSON.parse(localStorage.getItem('trip_todos')) || defaultTodos;
    let itinerary = JSON.parse(localStorage.getItem('trip_itinerary')) || initialItinerary;
    let isEditMode = false;

    // --- 2. æ ¸å¿ƒåŠŸèƒ½å‡½å¼ ---

    function init() {
        renderCountdown();
        renderTodos();
        renderItineraryTabs();
        renderItineraryContent(0);
        fetchWeather();
        
        // è¼‰å…¥å¯ç·¨è¼¯å€å¡Š (è‹¥ç„¡å‰‡ä½¿ç”¨é è¨­å€¼)
        document.getElementById('packing-list').innerHTML = localStorage.getItem('trip_packing') || defaultPackingList;
        document.getElementById('backup-list').innerHTML = localStorage.getItem('trip_backup') || defaultBackupNotes;
        document.getElementById('useful-links').innerHTML = localStorage.getItem('trip_links') || defaultLinks;
        
        // æ¯å¤©æ›´æ–°æ—¥æœŸ
        const now = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        document.getElementById('today-date').innerText = "ä»Šå¤©æ˜¯ " + now.toLocaleDateString('zh-TW', options);
    }

    // é€šç”¨ä¿å­˜å‡½æ•¸ (ç”¨æ–¼è£å‚™æ¸…å–®ã€å‚™å¿˜éŒ„ã€é€£çµ)
    window.saveContent = function(elementId, storageKey) {
        const content = document.getElementById(elementId).innerHTML;
        localStorage.setItem(storageKey, content);
        alert("å…§å®¹å·²ä¿å­˜ï¼");
    }

    // Tab åˆ‡æ›
    window.switchTab = function(pageId, element) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        element.classList.add('active');
        window.scrollTo(0,0);
    }

    // å€’æ•¸è¨ˆæ™‚
    function renderCountdown() {
        const targetDate = new Date("2026-01-05T00:00:00").getTime();
        const now = new Date().getTime();
        const diff = targetDate - now;
        const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
        document.getElementById('countdown-display').innerText = days > 0 ? days : (days > -7 ? "æ—…ç¨‹ä¸­" : "å·²çµæŸ");
    }

    // å¤©æ°£ API (Open-Meteo)
    async function fetchWeather() {
        // å“ˆçˆ¾æ¿±åº§æ¨™
        const lat = 45.75; 
        const lon = 126.63;
        try {
            const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
            const data = await response.json();
            const temp = data.current_weather.temperature;
            const code = data.current_weather.weathercode;
            
            // ç°¡æ˜“å¤©æ°£ä»£ç¢¼è½‰æ›
            let weatherText = "æ™´";
            if(code > 3) weatherText = "å¤šé›²";
            if(code > 50) weatherText = "æœ‰é›¨/é›ª";
            if(code > 70) weatherText = "ä¸‹é›ª â„ï¸";

            const displayStr = `${weatherText} ${temp}Â°C`;
            document.getElementById('weather-api-display').innerHTML = `<span style="font-size:1.5rem; font-weight:bold;">${displayStr}</span>`;
            
            // è©³ç´°é é¢
            document.getElementById('weather-temp-harbin').innerText = `${temp}Â°`;
            document.getElementById('weather-desc-harbin').innerText = weatherText;
            document.getElementById('weather-hum-harbin').innerText = "ä¹¾ç‡¥"; // APIç°¡æ˜“ç‰ˆç„¡æ¿•åº¦ï¼Œå“ˆçˆ¾æ¿±å†¬å¤©é è¨­ä¹¾ç‡¥

        } catch (e) {
            document.getElementById('weather-api-display').innerText = "ç„¡æ³•å–å¾—å¤©æ°£ (è«‹æª¢æŸ¥ç¶²è·¯)";
        }
    }

    // --- 3. å¾…è¾¦äº‹é …é‚è¼¯ ---
    function renderTodos() {
        const list = document.getElementById('todo-list');
        list.innerHTML = '';
        todos.forEach((todo, index) => {
            const div = document.createElement('div');
            div.className = 'todo-item';
            div.innerHTML = `
                <input type="checkbox" ${todo.done ? 'checked' : ''} onchange="toggleTodo(${index})">
                <span class="todo-text" contenteditable="true" onblur="updateTodoText(${index}, this.innerText)" style="text-decoration: ${todo.done ? 'line-through' : 'none'}; color: ${todo.done ? '#ccc' : 'inherit'}">${todo.text}</span>
                <span class="delete-btn" onclick="deleteTodo(${index})">âœ•</span>
            `;
            list.appendChild(div);
        });
        localStorage.setItem('trip_todos', JSON.stringify(todos));
    }

    window.addTodo = function() {
        todos.push({ text: "æ–°äº‹é …...", done: false });
        renderTodos();
    }

    window.toggleTodo = function(index) {
        todos[index].done = !todos[index].done;
        renderTodos();
    }
    
    window.updateTodoText = function(index, text) {
        todos[index].text = text;
        localStorage.setItem('trip_todos', JSON.stringify(todos));
    }

    window.deleteTodo = function(index) {
        if(confirm('åˆªé™¤æ­¤äº‹é …ï¼Ÿ')) {
            todos.splice(index, 1);
            renderTodos();
        }
    }

    // --- 4. è¡Œç¨‹è¡¨é‚è¼¯ ---
    function renderItineraryTabs() {
        const container = document.getElementById('day-tabs');
        container.innerHTML = '';
        itinerary.forEach((day, index) => {
            const btn = document.createElement('button');
            btn.className = `day-tab ${index === 0 ? 'active' : ''}`;
            btn.innerText = day.day;
            btn.onclick = () => {
                document.querySelectorAll('.day-tab').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderItineraryContent(index);
            };
            container.appendChild(btn);
        });
    }

    function renderItineraryContent(dayIndex) {
        const dayData = itinerary[dayIndex];
        const container = document.getElementById('itinerary-content');
        
        let html = `
            <div class="card" style="border-top: 5px solid var(--primary);">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 contenteditable="${isEditMode}" onblur="updateDayTitle(${dayIndex}, 'location', this.innerText)">${dayData.location}</h2>
                    <span style="color:var(--text-light); font-weight:bold;">${dayData.date}</span>
                </div>
                <div style="margin-top:10px;">
        `;

        dayData.items.forEach((item, itemIndex) => {
            const linkUrl = item.link || '';
            
            html += `
                <div class="timeline-item">
                    <div class="time-tag" contenteditable="${isEditMode}" onblur="updateItem(${dayIndex}, ${itemIndex}, 'time', this.innerText)">${item.time}</div>
                    <div style="font-size:1.1rem; margin-bottom:5px;" contenteditable="${isEditMode}" onblur="updateItem(${dayIndex}, ${itemIndex}, 'text', this.innerText)">${item.text}</div>
                    
                    ${isEditMode 
                        ? `<input type="text" class="link-input" placeholder="åœ¨æ­¤è²¼ä¸Šé€£çµ (http://...)" value="${linkUrl}" onblur="updateItem(${dayIndex}, ${itemIndex}, 'link', this.value)">` 
                        : (linkUrl ? `<a href="${linkUrl}" target="_blank" class="link-btn">ğŸ”— é–‹å•Ÿé€£çµ</a>` : '')
                    }

                    ${isEditMode ? `<button class="btn-small" style="background:#ff6b6b; margin-top:5px; margin-left:5px;" onclick="deleteItineraryItem(${dayIndex}, ${itemIndex})">åˆªé™¤</button>` : ''}
                    
                    <!-- åœ–ç‰‡å€åŸŸ -->
                    <div class="img-preview" id="img-${dayIndex}-${itemIndex}">
                        ${item.img ? `<img src="${item.img}">` : '<span>æš«ç„¡åœ–ç‰‡</span>'}
                        ${isEditMode ? `
                            <label class="upload-btn">
                                ğŸ“· <input type="file" class="file-input" accept="image/*" onchange="uploadImage(this, ${dayIndex}, ${itemIndex})">
                            </label>
                        ` : ''}
                    </div>
                </div>
            `;
        });

        if(isEditMode) {
            html += `<button class="btn-small" style="width:100%; margin-top:10px; background:var(--secondary);" onclick="addItineraryItem(${dayIndex})">+ æ–°å¢è¡Œç¨‹</button>`;
        }

        html += `</div></div>`;
        container.innerHTML = html;
        container.dataset.currentIndex = dayIndex; // å„²å­˜ç•¶å‰ Day Index
    }

    // ç·¨è¼¯åŠŸèƒ½
    window.toggleEditMode = function() {
        isEditMode = !isEditMode;
        document.getElementById('edit-mode-btn').innerText = isEditMode ? "âœ… å®Œæˆç·¨è¼¯" : "âœï¸ ç·¨è¼¯è¡Œç¨‹";
        const currentIndex = document.getElementById('itinerary-content').dataset.currentIndex || 0;
        renderItineraryContent(parseInt(currentIndex));
    }

    window.updateItem = function(dayIdx, itemIdx, field, value) {
        itinerary[dayIdx].items[itemIdx][field] = value;
        localStorage.setItem('trip_itinerary', JSON.stringify(itinerary));
    }
    
    window.updateDayTitle = function(dayIdx, field, value) {
        itinerary[dayIdx][field] = value;
        localStorage.setItem('trip_itinerary', JSON.stringify(itinerary));
    }

    window.addItineraryItem = function(dayIdx) {
        itinerary[dayIdx].items.push({ time: "æ™‚é–“", text: "æ–°æ´»å‹•", img: "", link: "" });
        localStorage.setItem('trip_itinerary', JSON.stringify(itinerary));
        renderItineraryContent(dayIdx);
    }

    window.deleteItineraryItem = function(dayIdx, itemIdx) {
        if(confirm("ç¢ºå®šåˆªé™¤?")) {
            itinerary[dayIdx].items.splice(itemIdx, 1);
            localStorage.setItem('trip_itinerary', JSON.stringify(itinerary));
            renderItineraryContent(dayIdx);
        }
    }

    // åœ–ç‰‡è™•ç† (è½‰æ›ç‚º Base64 å­˜å…¥ LocalStorage - æ³¨æ„ï¼šå®¹é‡æœ‰é™ï¼Œåƒ…é©åˆå°‘é‡å°åœ–)
    window.uploadImage = function(input, dayIdx, itemIdx) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // å£“ç¸®åœ–ç‰‡ä»¥å…çˆ† localStorage
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 500; // é™åˆ¶å¯¬åº¦
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    const compressedData = canvas.toDataURL('image/jpeg', 0.7);
                    itinerary[dayIdx].items[itemIdx].img = compressedData;
                    localStorage.setItem('trip_itinerary', JSON.stringify(itinerary));
                    renderItineraryContent(dayIdx);
                }
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // --- 5. å…¶ä»–åŠŸèƒ½ ---

    // åŠ å…¥æ—¥æ›† (ç”Ÿæˆ .ics æª”æ¡ˆ)
    window.addToCalendar = function(title, startStr, endStr, desc) {
        // startStr format: 2026-01-05T10:00:00
        // ICS format: 20260105T100000
        const formatTime = (str) => str.replace(/[-:]/g, "").split('.')[0];
        
        const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
URL:${document.location.href}
DTSTART:${formatTime(startStr)}
DTEND:${formatTime(endStr)}
SUMMARY:${title}
DESCRIPTION:${desc}
END:VEVENT
END:VCALENDAR`;

        const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
        const link = document.createElement('a');
        link.href = window.URL.createObjectURL(blob);
        link.setAttribute('download', 'trip_reminder.ics');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // å•Ÿå‹•
    init();

</script>

</body>
</html>
